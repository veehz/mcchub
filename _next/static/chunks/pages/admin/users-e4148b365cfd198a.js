(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[635],{4168:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/users",function(){return t(5037)}])},8917:function(e,n,t){"use strict";t.r(n),t.d(n,{PaymentCard:function(){return m},default:function(){return v}});var l=t(5893),s=t(8804),a=t(7312),i=t(8063),d=t.n(i),r=t(5696),o=t(1019),c=t(6650),u=t(7294);let m=e=>{var n;let{payment:t,showUid:a=!0}=e,{userId:i,paymentId:m}=t,v=(null==t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)||"pending",[h,p]=(0,u.useState)(null),[x,f]=(0,u.useState)(!1),[j,y]=(0,u.useState)(!1);async function b(e){f(!0);try{await (0,o.t8)((0,o.iH)(r.db,"payments/".concat(i,"/").concat(m,"/approved")),{status:e,by:r.I.currentUser.uid})}catch(e){}f(!1)}return(0,l.jsxs)("div",{className:"rounded-lg overflow-hidden shadow-lg p-4 mb-4 w-full",children:[(0,l.jsxs)("div",{className:"font-bold text-xl mb-2",children:[a?"".concat(i,": "):null," #",m]}),(0,l.jsxs)("div",{className:"text-gray-700 text-base mb-2",children:["Payment of: ",d().currency,null==t?void 0:t.amount," "]}),(0,l.jsxs)("div",{className:"flex",children:[(0,l.jsxs)(s.Z,{className:"mx-2 my-1",onClick:()=>{let e=(0,c.cF)();h||(0,c.Jt)((0,c.iH)(e,"paymentProof/".concat(i,"/").concat(m,"-").concat(t.uniqueId,".").concat(t.fileExtension))).then(e=>{p(e)}),y(!j)},children:[j?"Hide":"View"," Payment Proof"]}),(0,l.jsx)(s.Z,{className:"mx-2 my-1",onClick:()=>{let e=(0,c.cF)();(0,c.Jt)((0,c.iH)(e,"paymentProof/".concat(i,"/").concat(m,"-").concat(t.uniqueId,".").concat(t.fileExtension))).then(e=>{window.open(e,"_blank")})},children:"Download Payment Proof"}),"approved"==v||(0,l.jsx)(s.Z,{className:"mx-2 my-1 bg-green-500",onClick:()=>b("approved"),isLoading:x,children:"Approve Payment"}),"pending"==v||(0,l.jsx)(s.Z,{className:"mx-2 my-1 bg-yellow-500",onClick:()=>b("pending"),isLoading:x,children:"Set Payment as Pending"}),"rejected"==v||(0,l.jsx)(s.Z,{className:"mx-2 my-1 bg-red-500",onClick:()=>b("rejected"),isLoading:x,children:"Reject Payment"})]}),(0,l.jsx)("div",{className:"my-4",children:h&&j?(0,l.jsx)("iframe",{src:h,width:"100%",height:"500px"}):null})]})};function v(){var e;let[n,t]=(0,u.useState)({});(0,u.useEffect)(()=>{(0,o.jM)((0,o.iH)(r.db,"payments"),e=>{let n={approved:[],pending:[],rejected:[]};if(!e.val())return n;for(let t in e.val())for(let s in e.val()[t]){var l;let a=e.val()[t][s];(null==a?void 0:null===(l=a.approved)||void 0===l?void 0:l.status)?n[a.approved.status].push({...a,userId:t,paymentId:s}):n.pending.push({...a,userId:t,paymentId:s})}t(n)})},[]);let[i,d]=(0,u.useState)("");return(0,l.jsx)(a.Z,{title:"Payments",children:(0,l.jsxs)("div",{className:"flex flex-col md:flex-row md:flex-wrap",children:[(0,l.jsx)(s.Z,{className:"md:w-fit md:mx-2 my-2",onClick:()=>d("approved"),children:"Show Approved Payments"}),(0,l.jsx)(s.Z,{className:"md:w-fit md:mx-2 my-2",onClick:()=>d("pending"),children:"Show Pending Approval Payments"}),(0,l.jsx)(s.Z,{className:"md:w-fit md:mx-2 my-2",onClick:()=>d("rejected"),children:"Show Rejected Payments"}),i?null===(e=n[i])||void 0===e?void 0:e.map(e=>{let{userId:n,paymentId:t}=e;return(0,l.jsx)(m,{payment:e},n+"-"+t)}):null]})})}},5037:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return g}});var l=t(5893),s=t(8804),a=t(7312),i=t(1758),d=t(5696),r=t(1019),o=t(7294),c=t(8917),u=t(1664),m=t.n(u),v=t(1163),h=t(8063),p=t.n(h);let x=(e,n)=>e+n,f={and:(e,n)=>e&&n,or:(e,n)=>e||n,xor:(e,n)=>e!=n},j={and:!0,or:!1,xor:!1};function y(e){let n="";return e.line1&&(n+=e.line1+"\n"),e.line2&&(n+=e.line2+"\n"),e.city&&(n+=e.city+"\n"),e.postalCode&&(n+=e.postalCode+"\n"),e.state&&(n+=e.state+"\n"),e.country&&(n+=e.country+"\n"),n}let b=e=>{var n,t,a,i,u;let{userId:v,users:h,nricData:b,role:g,managedStudents:N,payments:k,searchKey:w}=e,[S,C]=(0,o.useState)(!1),[P,O]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{if(w){C(!0);let e=w.trim().split(" ").map(e=>e.toLowerCase().trim()).filter(e=>e.length>0),n=[],t={};for(let l of e)if(l.includes(":")){let[e,n]=l.split(":");t[e]=n}else n.push(l);let l=[];for(let e of n){let n=!1;for(let t of Object.keys(h[v]))if(("number"==typeof h[v][t]||"string"==typeof h[v][t])&&h[v][t].toLowerCase().includes(e)){n=!0;break}l.push(n)}if("true"==t.due){let e=Object.keys(N).length*p().registration_fee,n=Object.keys(k).filter(e=>{var n,t;return(null===(t=k[e])||void 0===t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)=="approved"}).map(e=>parseFloat(k[e].amount)).reduce(x,0);l.push(e>n)}t.role&&l.push(g==t.role),t.managerof&&l.push(t.managerof in N);let s=l.reduce(f.and,j.and);t.searchtype&&t.searchtype in f&&(s=l.reduce(f[t.searchtype],j[t.searchtype])),"true"==t.not&&(s=!s),C(!s)}else C(!1)},[w,k,N,g,v,h]),(0,l.jsxs)("div",{className:"rounded-lg overflow-hidden shadow-lg p-4 mb-4"+(S?" hidden":""),children:[(0,l.jsxs)("div",{className:"font-bold text-xl mb-2",children:[null===(n=h[v])||void 0===n?void 0:n.name,": ",h[v].email]}),(0,l.jsx)("div",{className:"text-gray-700 text-base mb-2",children:(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-bold",children:"User ID"}),": ",v]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-bold",children:"Role"}),": ",g]}),Object.keys(h[v]).filter(e=>!["email","name","nric","billingAddress"].includes(e)).map(e=>(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-bold",children:function(e){let n=e.split(" ");for(let e=0;e<n.length;e++)n[e]=n[e].charAt(0).toUpperCase()+n[e].slice(1);return n.join(" ")}(e)}),":"," ",h[v][e]]},e)),Object.keys((null===(t=h[v])||void 0===t?void 0:t.billingAddress)||{}).length?(0,l.jsxs)("div",{className:"display-linebreak",children:[(0,l.jsx)("span",{className:"font-bold",children:"Billing Address"}),":",(0,l.jsx)("br",{}),y(h[v].billingAddress)]}):null,"teacher"==g||"parent"==g?(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"font-bold",children:["Payments: ",k?Object.keys(k).length:null," ","(Approved:"," ",k?Object.keys(k).filter(e=>{var n,t;return(null===(t=k[e])||void 0===t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)=="approved"}).length:null,", Pending:"," ",k?Object.keys(k).filter(e=>{var n,t,l,s;return!(null===(t=k[e])||void 0===t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)||(null===(s=k[e])||void 0===s?void 0:null===(l=s.approved)||void 0===l?void 0:l.status)=="pending"}).length:null,", Rejected:"," ",k?Object.keys(k).filter(e=>{var n,t;return(null===(t=k[e])||void 0===t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)=="rejected"}).length:null,")"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-bold",children:"Need to pay:"})," ",p().currency,Object.keys(N).length*p().registration_fee]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-bold",children:"Approved Payment:"})," ",p().currency,Object.keys(k).filter(e=>{var n,t;return(null===(t=k[e])||void 0===t?void 0:null===(n=t.approved)||void 0===n?void 0:n.status)=="approved"}).map(e=>parseFloat(k[e].amount)).reduce(x,0)]})]}):null,"teacher"==g||"parent"==g?(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"font-bold",children:["Students: ",Object.keys(N||{}).length]}),(0,l.jsx)("div",{className:"flex flex-col",children:Object.keys(N||{}).map(e=>{var n,t;return(0,l.jsxs)("div",{className:(null===(n=b[e])||void 0===n?void 0:n.student)?"text-green-500":"text-red-500",children:[e," ",(null===(t=b[e])||void 0===t?void 0:t.student)?(0,l.jsxs)("div",{children:["(",h[b[e].student].email,")"]}):null,(0,l.jsx)("span",{className:"text-blue-600 font-bold hover:opacity-75 cursor-pointer",onClick:()=>{let n={};n["nric/".concat(h[b[e].student].nric,"/manager")]=null,n["managedStudents/".concat(v,"/").concat(e)]=null,(0,r.Vx)((0,r.iH)(d.db),n)},children:"Unbind"})]},e)})})]}):null,"student"==g&&(null===(a=h[v])||void 0===a?void 0:a.nric)?(0,l.jsx)("div",{children:(0,l.jsxs)("div",{className:"font-bold",children:["NRIC/Passport Number:"," ",(0,l.jsxs)("span",{className:(null===(i=b[h[v].nric])||void 0===i?void 0:i.manager)?"text-green-500":"text-red-500",children:[h[v].nric," ",(null===(u=b[h[v].nric])||void 0===u?void 0:u.manager)?"(manager: ".concat(h[b[h[v].nric].manager].email,")"):null]})]})}):null]})}),(0,l.jsxs)("div",{className:"flex flex-wrap",children:[(0,l.jsx)(m(),{href:{pathname:"/admin/users/edit",query:{id:v}},children:(0,l.jsx)(s.Z,{className:"mx-2 my-1",children:"Edit User"})}),"teacher"==g||"parent"==g?(0,l.jsx)(s.Z,{className:"mx-2 my-1",onClick:()=>O(!P),children:P?"Hide Payments":"View Payments"}):null]}),k&&P?Object.keys(k).map(e=>(0,l.jsx)(c.PaymentCard,{payment:{...k[e],userId:v,paymentId:e},showUid:!1},v+"-"+e)):null]})};function g(){let[e,n]=(0,o.useState)(!1),[t,c]=(0,o.useState)(""),[u,m]=(0,o.useState)(!1),[h,p]=(0,o.useState)({}),[x,f]=(0,o.useState)({}),[j,g]=(0,o.useState)({}),[N,k]=(0,o.useState)({}),[w,S]=(0,o.useState)({});function C(){e||(n(!0),(0,r.jM)((0,r.iH)(d.db,"users"),e=>{e.val(),p(e.val()||{})}),(0,r.jM)((0,r.iH)(d.db,"nric"),e=>{e.val(),g(e.val()||{})}),(0,r.jM)((0,r.iH)(d.db,"role"),e=>{e.val(),f(e.val()||{})}),(0,r.jM)((0,r.iH)(d.db,"managedStudents"),e=>{e.val(),k(e.val()||{})}),(0,r.jM)((0,r.iH)(d.db,"payments"),e=>{e.val(),S(e.val()||{})}))}let P=(0,v.useRouter)();return(0,o.useEffect)(()=>{var e;(null==P?void 0:null===(e=P.query)||void 0===e?void 0:e.fetch)&&C()}),(0,l.jsx)(a.Z,{title:"Users",children:(0,l.jsxs)("div",{className:"place-content-center w-full",children:[(0,l.jsx)(s.Z,{className:"mx-auto"+(e?" hidden":""),onClick:()=>C(),children:"Fetch All Users"}),(0,l.jsxs)("div",{hidden:!e,children:[(0,l.jsxs)("div",{className:"text-gray-500 text-center",children:[(0,l.jsx)("div",{hidden:Object.keys(h).length>0,children:"Loading Users Data"}),(0,l.jsx)("div",{hidden:Object.keys(j).length>0,children:"Loading NRIC Data"})]}),(0,l.jsx)(s.Z,{className:"ml-auto",onClick:function(){!function(e,n){let t=new Blob([e],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),s=URL.createObjectURL(t);l.setAttribute("href",s),l.setAttribute("download",n),document.body.appendChild(l),l.click(),document.body.removeChild(l)}(function(e,n){let t=n.join(",")+"\n",l=e=>{if("string"!=typeof e)return e;let n=e.replace(/"/g,'""');return n.includes(",")||n.includes('"')||n.includes("\n")?'"'.concat(n,'"'):n};return t+e.map(e=>n.map(n=>l(e[n])).join(",")).join("\n")}(Object.keys(h).map(e=>{var n,t,l,s,a,i,d,r,o,c;return{"User ID":e,Name:null===(n=h[e])||void 0===n?void 0:n.name,Email:null===(t=h[e])||void 0===t?void 0:t.email,Role:x[e],Form:null===(l=h[e])||void 0===l?void 0:l.form,Gender:null===(s=h[e])||void 0===s?void 0:s.gender,"Date of Birth":null===(a=h[e])||void 0===a?void 0:a.dob,State:null===(i=h[e])||void 0===i?void 0:i.state,Country:null===(d=h[e])||void 0===d?void 0:d.country,School:null===(r=h[e])||void 0===r?void 0:r.school,"Identification Number":null===(o=h[e])||void 0===o?void 0:o.nric,"Billing Address":y((null===(c=h[e])||void 0===c?void 0:c.billingAddress)||{}),"Managed Students":Object.keys(N[e]||{}).join(", "),Payments:Object.keys(w[e]||{}).join(", ")}}),["User ID","Name","Email","Role","Form","Gender","Date of Birth","State","Country","School","Nationality","Identification Number","Billing Address","Managed Students","Payments"]),"users.csv")},children:"Export Users"}),(0,l.jsx)(i.Z,{placeholder:"Search",inputName:null,props:{onChange:e=>{c(e.target.value)}}}),(0,l.jsx)("div",{className:"mx-2 text-sm underline text-blue-500 cursor-pointer hover:opacity-90",onClick:()=>{m(!u)},children:"Advanced Search Guide"}),(0,l.jsxs)("div",{className:"mx-2 text-sm m-2 p-2 rounded-md border border-solid border-black",hidden:!u,children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-mono bg-gray-200",children:"due:true"})," shows teachers whose approved payments are not enough to cover the registration fees."]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-mono bg-gray-200",children:"role:student | parent | teacher | admin"})," ","shows users with the respective role."]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-mono bg-gray-200",children:"managerof:[nric]"})," ","shows users with [nric] as their managed student."]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-mono bg-gray-200",children:"searchtype:and | or | xor"})," ","determines the search type (default: and)"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-mono bg-gray-200",children:"not:true"})," inverts the search results"]})]}),(0,l.jsx)("div",{className:"flex flex-col",children:Object.keys(h).map(e=>(0,l.jsx)(b,{userId:e,users:h,nricData:j,role:x[e],managedStudents:N[e]||{},payments:w[e]||{},searchKey:t},e))})]})]})})}}},function(e){e.O(0,[627,257,414,650,584,888,774,179],function(){return e(e.s=4168)}),_N_E=e.O()}]);