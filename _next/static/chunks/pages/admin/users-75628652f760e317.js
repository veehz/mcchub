(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[635],{4168:function(e,n,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/users",function(){return s(5037)}])},1758:function(e,n,s){"use strict";s.d(n,{Z:function(){return l}});var t=s(5893);function l(e){let{id:n,inputName:s,placeholder:l,hook:i,disabled:r=!1,errorMsg:d,props:a}=e;return(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("div",{className:"px-2 py-1",children:(0,t.jsx)("label",{htmlFor:n,children:void 0===s?l:s||null})}),(0,t.jsx)("input",{type:"text",className:"rounded-md relative block w-full border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 disabled:opacity-75 disabled:bg-slate-100"+(d?" ring-red-500":""),disabled:r,id:n,placeholder:l,...a,...i}),(0,t.jsx)("div",{className:"px-2 py-1",children:(0,t.jsx)("div",{className:"text-sm text-red-500",children:d})})]})}},5037:function(e,n,s){"use strict";s.r(n),s.d(n,{default:function(){return y}});var t=s(5893),l=s(8804),i=s(7312),r=s(1758),d=s(5696),a=s(1019),o=s(7294),c=s(8917),u=s(1664),v=s.n(u),h=s(1163),m=s(8063),p=s.n(m);let x=(e,n)=>e+n,j={and:(e,n)=>e&&n,or:(e,n)=>e||n,xor:(e,n)=>e!=n},f={and:!0,or:!1,xor:!1};function b(e){let n="";return e.line1&&(n+=e.line1+"\n"),e.line2&&(n+=e.line2+"\n"),e.city&&(n+=e.city+"\n"),e.postalCode&&(n+=e.postalCode+"\n"),e.state&&(n+=e.state+"\n"),e.country&&(n+=e.country+"\n"),n}let g=e=>{var n,s,i,r,u;let{userId:h,users:m,nricData:g,role:y,managedStudents:N,payments:k,searchKey:w}=e,[O,S]=(0,o.useState)(!1),[C,A]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{if(w){S(!0);let e=w.trim().split(" ").map(e=>e.toLowerCase().trim()).filter(e=>e.length>0),n=[],s={};for(let t of e)if(t.includes(":")){let[e,n]=t.split(":");s[e]=n}else n.push(t);let t=[];for(let e of n){let n=!1;for(let s of Object.keys(m[h]))if(m[h][s].toLowerCase().includes(e)){n=!0;break}t.push(n)}if("true"==s.due){let e=Object.keys(N).length*p().registration_fee,n=Object.keys(k).filter(e=>{var n,s;return(null===(s=k[e])||void 0===s?void 0:null===(n=s.approved)||void 0===n?void 0:n.status)=="approved"}).map(e=>parseFloat(k[e].amount)).reduce(x,0);t.push(e>n)}s.role&&t.push(y==s.role),s.managerof&&t.push(s.managerof in N);let l=t.reduce(j.and,f.and);s.searchtype&&s.searchtype in j&&(l=t.reduce(j[s.searchtype],f[s.searchtype])),"true"==s.not&&(l=!l),S(!l)}else S(!1)},[w,k,N,y,h,m]),(0,t.jsxs)("div",{className:"rounded-lg overflow-hidden shadow-lg p-4 mb-4"+(O?" hidden":""),children:[(0,t.jsxs)("div",{className:"font-bold text-xl mb-2",children:[null===(n=m[h])||void 0===n?void 0:n.name,": ",m[h].email]}),(0,t.jsx)("div",{className:"text-gray-700 text-base mb-2",children:(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-bold",children:"User ID"}),": ",h]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-bold",children:"Role"}),": ",y]}),Object.keys(m[h]).filter(e=>!["email","name","nric","billingAddress"].includes(e)).map(e=>(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-bold",children:function(e){let n=e.split(" ");for(let e=0;e<n.length;e++)n[e]=n[e].charAt(0).toUpperCase()+n[e].slice(1);return n.join(" ")}(e)}),":"," ",m[h][e]]},e)),Object.keys((null===(s=m[h])||void 0===s?void 0:s.billingAddress)||{}).length?(0,t.jsxs)("div",{className:"display-linebreak",children:[(0,t.jsx)("span",{className:"font-bold",children:"Billing Address"}),":",(0,t.jsx)("br",{}),b(m[h].billingAddress)]}):null,"teacher"==y||"parent"==y?(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"font-bold",children:["Payments: ",k?Object.keys(k).length:null," ","(Approved:"," ",k?Object.keys(k).filter(e=>{var n,s;return(null===(s=k[e])||void 0===s?void 0:null===(n=s.approved)||void 0===n?void 0:n.status)=="approved"}).length:null,", Pending:"," ",k?Object.keys(k).filter(e=>{var n,s,t,l;return!(null===(s=k[e])||void 0===s?void 0:null===(n=s.approved)||void 0===n?void 0:n.status)||(null===(l=k[e])||void 0===l?void 0:null===(t=l.approved)||void 0===t?void 0:t.status)=="pending"}).length:null,", Rejected:"," ",k?Object.keys(k).filter(e=>{var n,s;return(null===(s=k[e])||void 0===s?void 0:null===(n=s.approved)||void 0===n?void 0:n.status)=="rejected"}).length:null,")"]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-bold",children:"Need to pay:"})," ",p().currency,Object.keys(N).length*p().registration_fee]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-bold",children:"Approved Payment:"})," ",p().currency,Object.keys(k).filter(e=>{var n,s;return(null===(s=k[e])||void 0===s?void 0:null===(n=s.approved)||void 0===n?void 0:n.status)=="approved"}).map(e=>parseFloat(k[e].amount)).reduce(x,0)]})]}):null,"teacher"==y||"parent"==y?(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"font-bold",children:["Students: ",Object.keys(N||{}).length]}),(0,t.jsx)("div",{className:"flex flex-col",children:Object.keys(N||{}).map(e=>{var n,s;return(0,t.jsxs)("div",{className:(null===(n=g[e])||void 0===n?void 0:n.student)?"text-green-500":"text-red-500",children:[e," ",(null===(s=g[e])||void 0===s?void 0:s.student)?(0,t.jsxs)("div",{children:["(",m[g[e].student].email,","," ",(0,t.jsx)("span",{className:"text-blue-600 font-bold hover:opacity-75 cursor-pointer",onClick:()=>{let n={};n["managedStudents/".concat(h,"/").concat(e)]=null,n["nric/".concat(m[g[e].student].nric,"/manager")]=null,(0,a.Vx)((0,a.iH)(d.db),n)},children:"Unbind"}),")"]}):null]},e)})})]}):null,"student"==y&&(null===(i=m[h])||void 0===i?void 0:i.nric)?(0,t.jsx)("div",{children:(0,t.jsxs)("div",{className:"font-bold",children:["NRIC/Passport Number:"," ",(0,t.jsxs)("span",{className:(null===(r=g[m[h].nric])||void 0===r?void 0:r.manager)?"text-green-500":"text-red-500",children:[m[h].nric," ",(null===(u=g[m[h].nric])||void 0===u?void 0:u.manager)?"(manager: ".concat(m[g[m[h].nric].manager].email,")"):null]})]})}):null]})}),(0,t.jsxs)("div",{className:"flex flex-wrap",children:[(0,t.jsx)(v(),{href:{pathname:"/admin/users/edit",query:{id:h}},children:(0,t.jsx)(l.Z,{className:"mx-2 my-1",children:"Edit User"})}),"teacher"==y||"parent"==y?(0,t.jsx)(l.Z,{className:"mx-2 my-1",onClick:()=>A(!C),children:C?"Hide Payments":"View Payments"}):null]}),k&&C?Object.keys(k).map(e=>(0,t.jsx)(c.PaymentCard,{payment:{...k[e],userId:h,paymentId:e},showUid:!1},h+"-"+e)):null]})};function y(){let[e,n]=(0,o.useState)(!1),[s,c]=(0,o.useState)(""),[u,v]=(0,o.useState)(!1),[m,p]=(0,o.useState)({}),[x,j]=(0,o.useState)({}),[f,y]=(0,o.useState)({}),[N,k]=(0,o.useState)({}),[w,O]=(0,o.useState)({});function S(){e||(n(!0),(0,a.jM)((0,a.iH)(d.db,"users"),e=>{e.val(),p(e.val()||{})}),(0,a.jM)((0,a.iH)(d.db,"nric"),e=>{e.val(),y(e.val()||{})}),(0,a.jM)((0,a.iH)(d.db,"role"),e=>{e.val(),j(e.val()||{})}),(0,a.jM)((0,a.iH)(d.db,"managedStudents"),e=>{e.val(),k(e.val()||{})}),(0,a.jM)((0,a.iH)(d.db,"payments"),e=>{e.val(),O(e.val()||{})}))}let C=(0,h.useRouter)();return(0,o.useEffect)(()=>{var e;(null==C?void 0:null===(e=C.query)||void 0===e?void 0:e.fetch)&&S()}),(0,t.jsx)(i.Z,{title:"Users",children:(0,t.jsxs)("div",{className:"place-content-center w-full",children:[(0,t.jsx)(l.Z,{className:"mx-auto"+(e?" hidden":""),onClick:()=>S(),children:"Fetch All Users"}),(0,t.jsxs)("div",{hidden:!e,children:[(0,t.jsxs)("div",{className:"text-gray-500 text-center",children:[(0,t.jsx)("div",{hidden:Object.keys(m).length>0,children:"Loading Users Data"}),(0,t.jsx)("div",{hidden:Object.keys(f).length>0,children:"Loading NRIC Data"})]}),(0,t.jsx)(l.Z,{className:"ml-auto",onClick:function(){!function(e,n){let s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),l=URL.createObjectURL(s);t.setAttribute("href",l),t.setAttribute("download",n),document.body.appendChild(t),t.click(),document.body.removeChild(t)}(function(e,n){let s=n.join(",")+"\n",t=e=>{if("string"!=typeof e)return e;let n=e.replace(/"/g,'""');return n.includes(",")||n.includes('"')||n.includes("\n")?'"'.concat(n,'"'):n};return s+e.map(e=>n.map(n=>t(e[n])).join(",")).join("\n")}(Object.keys(m).map(e=>{var n,s,t,l,i,r,d,a,o,c;return{"User ID":e,Name:null===(n=m[e])||void 0===n?void 0:n.name,Email:null===(s=m[e])||void 0===s?void 0:s.email,Role:x[e],Form:null===(t=m[e])||void 0===t?void 0:t.form,Gender:null===(l=m[e])||void 0===l?void 0:l.gender,"Date of Birth":null===(i=m[e])||void 0===i?void 0:i.dob,State:null===(r=m[e])||void 0===r?void 0:r.state,Country:null===(d=m[e])||void 0===d?void 0:d.country,School:null===(a=m[e])||void 0===a?void 0:a.school,"Identification Number":null===(o=m[e])||void 0===o?void 0:o.nric,"Billing Address":b((null===(c=m[e])||void 0===c?void 0:c.billingAddress)||{}),"Managed Students":Object.keys(N[e]||{}).join(", "),Payments:Object.keys(w[e]||{}).join(", ")}}),["User ID","Name","Email","Role","Form","Gender","Date of Birth","State","Country","School","Nationality","Identification Number","Billing Address","Managed Students","Payments"]),"users.csv")},children:"Export Users"}),(0,t.jsx)(r.Z,{placeholder:"Search",inputName:null,props:{onChange:e=>{c(e.target.value)}}}),(0,t.jsx)("div",{className:"mx-2 text-sm underline text-blue-500 cursor-pointer hover:opacity-90",onClick:()=>{v(!u)},children:"Advanced Search Guide"}),(0,t.jsxs)("div",{className:"mx-2 text-sm m-2 p-2 rounded-md border border-solid border-black",hidden:!u,children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono bg-gray-200",children:"due:true"})," shows teachers whose approved payments are not enough to cover the registration fees."]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono bg-gray-200",children:"role:student | parent | teacher | admin"})," ","shows users with the respective role."]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono bg-gray-200",children:"managerof:[nric]"})," ","shows users with [nric] as their managed student."]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono bg-gray-200",children:"searchtype:and | or | xor"})," ","determines the search type (default: and)"]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono bg-gray-200",children:"not:true"})," inverts the search results"]})]}),(0,t.jsx)("div",{className:"flex flex-col",children:Object.keys(m).map(e=>(0,t.jsx)(g,{userId:e,users:m,nricData:f,role:x[e],managedStudents:N[e]||{},payments:w[e]||{},searchKey:s},e))})]})]})})}}},function(e){e.O(0,[627,257,414,650,917,888,774,179],function(){return e(e.s=4168)}),_N_E=e.O()}]);